log_format logstash_json '{ "@timestamp": "$time_iso8601", '
                         '"@fields": { '
                         '"remote_addr": "$remote_addr", '
                         '"remote_user": "$remote_user", '
                         '"body_bytes_sent": "$body_bytes_sent", '
                         '"request_time": "$request_time", '
                         '"status": "$status", '
                         '"request": "$request", '
                         '"request_method": "$request_method", '
                         '"http_referrer": "$http_referer", '
                         '"http_user_agent": "$http_user_agent" } }';
server {
    listen        0.0.0.0:80;
    server_name   "";

    # access_log   /var/log/nginx.access_log  main;
    access_log   /var/log/nginx.access_log  logstash_json;

    location / {
        # NB: web is an alias set up by docker-compose, it's the name of the
        # container running the flask process
        proxy_pass         http://web:8000/;
        proxy_redirect     off;

        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        #proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;

        client_max_body_size       10m;
        client_body_buffer_size    128k;

        client_body_temp_path      /var/nginx/client_body_temp;

        proxy_connect_timeout      70;
        proxy_send_timeout         90;
        proxy_read_timeout         90;
        proxy_send_lowat           12000;

        proxy_buffer_size          4k;
        proxy_buffers              4 32k;
        proxy_busy_buffers_size    64k;
        proxy_temp_file_write_size 64k;

        proxy_temp_path            /var/nginx/proxy_temp;

        charset  utf-8;
    }

    # error_page  404  /404.html;

    # location /404.html {
    #     root  /spool/www;
    # }

    # location /old_stuff/ {
    #     rewrite   ^/old_stuff/(.*)$  /new_stuff/$1  permanent;
    # }

    # location /download/ {

    #     valid_referers  none  blocked  server_names  *.example.com;

    #     if ($invalid_referer) {
    #         #rewrite   ^/   http://www.example.com/;
    #         return   403;
    #     }

    #     #rewrite_log  on;

    #     # rewrite /download/*/mp3/*.any_ext to /download/*/mp3/*.mp3
    #     rewrite ^/(download/.*)/mp3/(.*)\..*$
    #             /$1/mp3/$2.mp3                   break;

    #     root         /spool/www;
    #     #autoindex    on;
    #     access_log   /var/log/nginx-download.access_log  download;
    # }

    location ~* \.(jpg|jpeg|gif|js|html|css|png)$ {
        root         /www/static;
        # access_log   off;
        # expires      30d;
    }
}
