#!/usr/bin/env bash
INSTAL_PATH=/cygdrive/c/Users/kyle/AppData/Roaming/.minecraft
MINECRAFT_SERVER_JAR_URL="https://s3.amazonaws.com/Minecraft.Download/versions/1.8.3/minecraft_server.1.8.3.jar"
BAKCUP_DIR="$HOME/local/minecraft"
LTPWMP_CODE="http://media.pragprog.com/titles/ahmine2/code/ahmine2-code.zip"
CANARYMOD_LIB_JAR_URL="https://ci.visualillusionsent.net/job/CanaryLib/525/artifact/target/CanaryLib-1.2.0-shaded.jar"
# NB: this one can't be automated w/wget?
CANARYMOD_JAR_URL="http://canarymod.net/download/file/fid/361"

bake_task download_ltpwmp
function download_ltpwmp () {
  local fname="$(basename $LTPWMP_CODE)"
  wget --continue $LTPWMP_CODE
  test -d ahmine2-code || mkdir ahmine2-code
  cd ahmine2-code
  test -d code || unzip ../$fname
}

bake_task download_canarymod_jar
function download_canarymod_jar () {
  # NB: this one can't be automated w/wget?
  # local fname="$(basename $CANARYMOD_JAR_URL)"
  # wget --continue $CANARYMOD_JAR_URL
  local fname="$(basename $CANARYMOD_LIB_JAR_URL)"
  wget --continue $CANARYMOD_LIB_JAR_URL
}

function isodate () {
  date -u +"%Y-%m-%dT%H:%M:%SZ"
}

bake_task sync
function sync () {
  test -d data || mkdir data
  cd data
  rsync -avz $INSTAL_PATH/saves ./
}

bake_task backup
function backup () {
  bake_echo_red "Make sure the server is stopped first..."
  echo -n "Press Enter: "
  read FOO
  test -d "$BAKCUP_DIR" || mkdir $BAKCUP_DIR
  cd "$BAKCUP_DIR"
  rsync "$(bake_bakefile_dir)" ./
  bash
  local bname="${1:-backup}"
  local logmsg="$(isodate): $bname"
  sync
  test -d .git || git init
  git add .
  git commit -m "$logmsg"
}

bake_task restore 
function restore () {
  cd data
  rsync -avz ./saves $INSTAL_PATH/
}

bake_task install
function install () {
  local jfile="$(basename $MINECRAFT_SERVER_JAR_URL)"
  test -f  $jfile || wget $MINECRAFT_SERVER_JAR_URL
}


bake_task install_sun_jdk
function install_sun_jdk () {
  sudo apt-add-repository ppa:webupd8team/java
  sudo apt-get update
  sudo apt-get install oracle-java7-installer
}

bake_task run_server
function run_server () {
  jfile="$(basename $MINECRAFT_SERVER_JAR_URL)"
  java -Xms512M -Xmx1024M -jar $jfile nogui
}


bake_task run_canarymod_server
function run_canarymod_server () {
  set -x
  # java -cp /Users/kburton/Desktop/server/lib/clojure-1.6.0.jar  -Xms1024M -Xmx1024M -jar CanaryMod.jar
  CP="/Users/kburton/Desktop/server/lib/EZPlugin.jar"
  CP="$CP:/Users/kburton/personal/projects/sandbox/examples/minecraft/ahmine2-code/code/CiderNrepl/test:/Users/kburton/personal/projects/sandbox/examples/minecraft/ahmine2-code/code/CiderNrepl/src:/Users/kburton/personal/projects/sandbox/examples/minecraft/ahmine2-code/code/CiderNrepl/dev-resources:/Users/kburton/personal/projects/sandbox/examples/minecraft/ahmine2-code/code/CiderNrepl/resources:/Users/kburton/personal/projects/sandbox/examples/minecraft/ahmine2-code/code/CiderNrepl/target/classes:/Users/kburton/.m2/repository/org/tcrawley/dynapath/0.2.3/dynapath-0.2.3.jar:/Users/kburton/.m2/repository/clojure-complete/clojure-complete/0.2.3/clojure-complete-0.2.3.jar:/Users/kburton/.m2/repository/CanaryMod/CanaryMod/1.0.0-kburton/CanaryMod-1.0.0-kburton.jar:/Users/kburton/.m2/repository/org/clojure/java.classpath/0.2.0/java.classpath-0.2.0.jar:/Users/kburton/.m2/repository/cider/cider-nrepl/0.7.0/cider-nrepl-0.7.0.jar:/Users/kburton/.m2/repository/compliment/compliment/0.1.3/compliment-0.1.3.jar:/Users/kburton/.m2/repository/slamhound/slamhound/1.5.0/slamhound-1.5.0.jar:/Users/kburton/.m2/repository/cljs-tooling/cljs-tooling/0.1.3/cljs-tooling-0.1.3.jar:/Users/kburton/.m2/repository/EZPlugin/EZPlugin/1.0.0-kburton/EZPlugin-1.0.0-kburton.jar:/Users/kburton/.m2/repository/org/clojure/tools.nrepl/0.2.6/tools.nrepl-0.2.6.jar:/Users/kburton/.m2/repository/org/clojure/tools.trace/0.7.8/tools.trace-0.7.8.jar:/Users/kburton/.m2/repository/org/clojure/tools.namespace/0.2.5/tools.namespace-0.2.5.jar:/Users/kburton/.m2/repository/org/clojure/clojure/1.6.0/clojure-1.6.0.jar"
  java -cp $CP:CanaryMod.jar -Xms1024M -Xmx1024M net.canarymod.Main
  #ava -verbose:class -Xms1024M -Xmx1024M -jar CanaryMod.jar
}
